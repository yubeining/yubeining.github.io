---
title: 分布式
date: 2025-04-19
updated: 2025-04-19
categories: java
tags:
  - java
  - 笔记
top: 1
---

# 分布式

### 1、分布式锁

#### 使用原因

保证同一时间只有一个JVM进程可以对共享资源进行操作

实现方式  mysql、redis、redission、zk

#### mysql

依赖数据库的唯一性来实现资源锁定，比如主键、唯一索引等

#### redis

用setnx操作 key存在 返回0，否则返回1

优点：实现简单、性能好，可以支撑高并发的获取、释放锁操作

缺点：容易单点故障

#### redission客户端

调用lock和unlock方法

watchdog会在获取锁之后，每隔10s设置超时时间为30s，就算一直持有锁也不会出现key过期

#### zk

在/lock目录下创建一个临时有序的节点表示去抢占锁，所有创建的节点会按照先后顺序生成一个带有序编号的节点

线程创建节点后，获取/lock节点下的所有子节点，判断当前线程创建的节点是否是所有的节点的序号最小的

如果当前线程创建的节点是所有节点序号最小的节点，则认为获取锁成功

如果当前线程创建的节点不是所有节点序号最小的节点，则对节点序号的前一个节点添加一个事件监听，当前一个被监听的节点释放锁之后，触发回调通知，从而再次去尝试抢占锁

优点：

zookeeper分布式协调、强一致性、锁很健壮。如果获取不到，只需要添加一个监听器就可以了，不用一直轮询，性能消耗较小

缺点：

在高请求高并发下，系统疯狂加锁释放锁，最后zk承受不住压力导致宕机



### 2、分布式事务

#### 理解

一个事务跨越多个分布式系统，可能由不同组织或部门进行管理，之间需要协调完成一个复杂的业务操作

需要满足ACID原则

要去解决事务操作的数据一致性问题。

传统的关系型数据库不支持跨库的事务操作，使用主流的分布式框架，像seata，集成到spring生态中



#### 和Spring事务区分 

spring没有提供事务，只是提供对事务的管理和封装，本质上是数据库层面的事务，需要满足ACID特性





### 3、CAP理论和BASE理论

#### CAP理论

在分布式系统中，必须保证分区容错性，无法同时保证强一致性和可用性

C：强一致性：各个节点之间能及时同步数据

A：可用性：对外保证可用

P：分区容错性：遇到任何网络故障时，仍然能对外提供满足一致性和可用性到服务

只能从一致性和可用性之间进行取舍。

如果保证了一致性，那么传输数据的时候，向客户端提交的请求就会失败或者超时。

如果保证了可用性，那就不能暂停读写操作，但同时在写数据



#### BASE理论

BA：基本可用。出现故障的时候，运行损失部分可用性，但不等于系统不可用

S：中间状态：数据正在同步。允许数据存在中间状态，并认为该中间状态的存在不会影响系统的整体可用性

E：最终一致性：不要求数据实时达到一致，允许经过一段时间后再达到一致





### 4、如何设计一个分布式系统

1、数据一致性：不同节点的数据不一定一致，需要采用一致性协议来保证数据的一致性

2、负载均衡：为了提高系统的可靠性，需要将请求均匀地分配给不同的节点，采用负载均衡算法实现：轮询、随机、加权随机、加权轮询

3、分布式事务：多个节点之间可能需要协作完成一个事务，需要采用分布式事务保证事务的原子性、一致性、隔离性和持久性，TCC

4、消息队列：实现异步通信和解耦，采用kafka、rabbitMQ等技术





### 5、seata架构 

TC：事务协调者 维护全局和分支事务的状态，协调全局事务提交

TM：事务管理器 定义全局事务的范围，开始全局事务、提交或回滚全局事务

RM：资源管理器 管理分支事务处理的资源


### 6、分布式事务解决方案

主要使用seata的at模式解决

分为两个阶段：

1、阶段一RM：注册分支事务、记录undolog快照、执行业务sql并提交、报告事务状态

2、阶段二提交RM：删除undolog

3、阶段二回滚RM：根据undo-log恢复数据到更新前



